# PHP `trim()` 处理中文时导致乱码的原因与解决方案

## 问题描述

在 PHP 中使用 `trim()` 函数处理中文字符串时，可能会**误删中文字符的部分字节**，从而导致字符串乱码。

示例代码：

```php
$str = "　你好　"; // 注意：前后是全角空格（U+3000）
echo trim($str);
```

输出可能是乱码，或者中文字符被截断。

---

## 原因分析

1. `trim()` 是按字节处理字符串的函数，不支持多字节字符（如中文、全角符号）；
2. 当指定 `charlist` 中包含了非 ASCII 字符（如 UTF-8 中的全角空格 U+3000），`trim()` 可能会误删部分字节，破坏字符编码；
3. 默认 `trim()` 只删除 ASCII 范围的空白字符，不会自动识别中文或全角空格。

---

## 解决方案

### 方法一：使用正则替代 `trim()`，支持 Unicode 空白字符

```php
function mb_trim($str) {
    return preg_replace('/^\s+|\s+$/u', '', $str);
}

$str = "　你好　"; // 含全角空格
echo mb_trim($str); // 输出 "你好"
```

说明：

* 使用了 Unicode 模式的正则表达式 `/u`
* `\s` 匹配所有 Unicode 空白字符，包括：

  * 半角空格（U+0020）
  * 制表符（\t）
  * 换行（\n）
  * 全角空格（U+3000）

---

### 方法二：手动处理特定字符（如全角空格）

```php
function safe_trim($str) {
    $str = preg_replace('/^[\s\x{3000}]+|[\s\x{3000}]+$/u', '', $str);
    return $str;
}
```

此方法精确匹配半角+全角空白字符，可避免多字节被误截断。

---

## 小结

| 方法               | 是否安全 | 是否支持中文 | 推荐度 |
| ---------------- | ---- | ------ | --- |
| `trim()`         | ❌    | ❌      | 🚫  |
| `preg_replace()` | ✅    | ✅      | ✅✅✅ |
| mbstring 方案      | ✅    | ✅      | ✅✅  |


> 结论：**不要使用 `trim()` 处理包含中文或全角字符的多字节字符串**，建议用 `preg_replace()` 正则替代，开启 `/u` Unicode 模式。

